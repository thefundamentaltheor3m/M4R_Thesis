\section{The Formalisation Effort: A Broad Overview}
\label{Ch5:Sec:Gen_Overview_of_Formalisation}

As was mentioned in \Cref{Ch1:Chapter}, the formalisation of Viazovska's proof was initiated by Viazovska and Hariharan in March 2024. A public announcement was made in June 2024, following which Birkbeck, Lee, and Ma joined the collaboration. Macbeth and Mehta too have made significant contributions since October 2024.

All code pertaining to the formalisation of the contents of \Cref{Ch4:Chapter} that does not come from the broader theory of modular forms has been written solely by the author, with advice from Mehta. While the formalisation is not complete, the author's progress is best interpreted as providing important tools and frameworks that will significantly ease the remainder of the formalisation.

The most significant difference between the author's exposition and Viazovska's original proof is that the author uses six defining integrals instead of four, with all contours being rectangular. The reason this is useful is that a formal version of the \CGT\ that exists in \mathlib\ for rectangular contours. A crucial step in \Cref{Ch4:Sec:Double_Zeroes} involves deforming unbounded contours, and the author formalised an appropriate version of the \CGT\ to work around this problem. The author's work builds on the \mathlib\ version for bounded rectangular contours, and hypothesised that it would be easier to adapt the definitions and proofs preceding that of double zeroes to a function defined using rectangular contours than it would to prove an unbounded version of the \CGT\ involving circular or triangular contours. Unfortunately, the proof of the eigenfunction property is not compatible with rectangular contours, but the author remains confident in the possibility of a workaround. We continue this discussion in \Cref{Ch5:Sec:Cauchy-Goursat}.

Viazovska's proof is heavy on computation. At the beginning of this M4R, the author was unaccustomed to proving computationally intensive results in Lean. While early attempts involved writing lengthy calculation lemmas, the author soon discovered that breaking computations into several lemmas corresponding to individual steps improved not only readability but also compilation time. The author's formal proof of \Cref{SP:PolyFourierCoeffBound}, for example, consists of thirteen auxiliary lemmas corresponding to individual steps, and the author's formal proofs of the bounds on each of the $I_1, \ldots, I_6$ are spread across two files: one with alternate expressions for all the $I_j$s and one with bounds on the $I_j$ in question. A further advantage of this approach is its isolation of dependencies that are difficult to formalise, such as convergence results for sums, products and integrals that arise in either the statement or proof of a result. In some cases, one finds workarounds: for instance, when bounding the $I_j$, the author realised that the proof that the $I_j$ converge absolutely is not necessary because of the way integrals are defined in \mathlib. The necessity of such excruciating detail in formal proofs was the author's key motivator to provide detailed arguments in \Cref{Ch4:Chapter}: the author's intent is for the proofs in this thesis to be a bridge between the informal and the formal, building on Viazovska's arguments in \cite[\S 7]{blueprint}.

For the remainder of this section, we briefly discuss two contributions the author made to the formalisation that account for differences, however minor, between Viazovska's original proof and the author's exposition. We then move onto two dedicated sections that respectively describe the metaprogramming approach implemented by Macbeth, Xie and the author and the challenges associated with the \CGT\ and how some, though not all, of them have been overcome.

\subsection{A Systematic Approach to Bounding Integrals}
\label{Ch5:Subsec:Bounding_Integrals}

Before the idea of rectangular contours, the author attempted to express $I_1 + I_2$ using a triangular contour. In fact, the author succeeded in bounding it by following the arguments in \cite{Viazovska8}. However, once the idea of rectangular contours was conceived, the author realised that six integrals would need to be bounded instead of four, as in \cite{Viazovska8}. The author hence decided to systematise his approach to maximise reusability of code. Indeed, that the proofs of \Cref{Ch4:Eq:Bound_I1_I3_I5,Ch4:Eq:Bound_I2_I4,Ch4:Eq:Bound_I6} are direct informalisations of the formal proofs found in the repository. There is one file per integral in the directory \lstinline|MagicFunction.a.IntegralEstimates|, but the structure is nearly identical for those integrals bounded using the same techniques, reflecting the systematic nature of the approach. All specific references in this subsection will involve the $I_j$, though we emphasise, as we did in \Cref{Ch4:Subec:Schwartzness_b}, that the $J_j$ are expected to work similarly.

The integrals are defined using parametrisations involving a real variable, so that API on \lstinline|intervalIntegral| could be used. To maximise compatibility, the most frequently used versions of the $\phi$-functions and the parametrisations are extensions of these functions to $\C$ and $\R$ respectively that are $0$ outside of where they are meant to be defined. This is in line with the \mathlib\ style of defining constructions like sums, integrals and products to take trivial values outside when these constructions are not well-defined in informal mathematics. We now give a step-by-step breakdown of how the author bounded integrals in Lean.

\begin{enumerate}
    \item \underline{Expressing the integrands in a convenient form.}

    Aside from enhancing readability and underscoring the resemblance of the formal integrals to the informal integrals, parametrisations are a way to control the variable of integration. However, they come with a layer of syntax that is unhelpful for bounding. Hence, we define lemmas ending in \lstinline|_eq| and \lstinline|_eq'| to overcome them.
    
    \lstinline|_eq| lemmas expand the parametrisations and perform basic simplifications, such as separating a term of the form $e^{\pi i r\parenth{1 + it}}$ into $e^{\pi i r} \cdot e^{-\pi r t}$. \lstinline|_eq'| lemmas take any scalars arising from this process (such as a factor of $i$ from a parametrisation $z = 1 + it$) outside of the integral, which makes them easier to deal with when bounding the integral. These lemmas are proved in \lstinline|MagicFunction.a.Basic| for all $I_j$, whereas the remaining steps are proved in individual files in \lstinline|MagicFunction.a.IntegralEstimates|.

    \item \underline{Changing variables (first, third and fifth integrals only).}

    Informally and formally, the key to bounding the first, third, and fifth integrals of both eigenfunctions is to perform a change of variables $s = \frac{1}{t}$. We do this by applying \href{https://github.com/leanprover-community/mathlib4/blob/5a2eaa85c555c4263e15928cef249cbaad2eb2d2/Mathlib/MeasureTheory/Function/Jacobian.lean#L1199}{a crucial \mathlib\ result} that was originally formalised by Loeffler in a file authored by Gouëzel in \mathlib3 and subsequently ported to \mathlib4. An intermediate lemma syntactically shows that the integral obtained by applying the change of variables is exactly what is required.

    \item \underline{Bounding the integrand.}

    By inspection, one sees that in \Cref{Ch4:Eq:Bound_I1_I3_I5,Ch4:Eq:Bound_I2_I4,Ch4:Eq:Bound_I6}, the bounds on the integrals actually come from bounds on the integrands. This is done formally using two lemmas, the first performing elementary bounds and the second applying \Cref{SP:PolyFourierCoeffBound}. The application of \Cref{SP:PolyFourierCoeffBound} is less straightforward for $I_2$ and $I_4$ because the condition $\Im(z) > \frac{1}{2}$ is more difficult to show (as seen in the informal proof of \Cref{Ch4:Eq:Bound_I2_I4} as well), so there are added helper lemmas for this.

    \item \underline{Bounding the integral.}

    This involves applying the \href{https://github.com/leanprover-community/mathlib4/blob/5a2eaa85c555c4263e15928cef249cbaad2eb2d2/Mathlib/MeasureTheory/Integral/Bochner/Basic.lean#L927}{triangle inequality} and \href{https://github.com/leanprover-community/mathlib4/blob/5a2eaa85c555c4263e15928cef249cbaad2eb2d2/Mathlib/MeasureTheory/Integral/Bochner/Set.lean#L645}{monotonicity of the integral}, which were formalised in \mathlib\ well before this project. Applying the former is straightforward, but applying the latter is not, because it requires integrability assumptions on the functions in question. The reason for this is that if $f \leq g$ and $f$ is integrable but $g$ is not, then the integral of $g$, as defined in Lean, is $0$. Fortunately, for nonnegative $f$ and $g$ (such as the absolute values of our integrands and the functions that bound them), only needs $g$ to be integrable. Integrability proofs for some bounding functions are currently \sorry s.
\end{enumerate}

The systematic nature of this approach makes it easy to reuse: the only differences between the computations for similar integrals are in the \lstinline|g|s and the \lstinline|_eq| and \lstinline|_eq'| lemmas that are invoked at various points. Thus, the overall complexity of the task was reduced substantially.

\subsection{A Schwartzness Bridge Across Dimensions}
\label{Ch5:Subsec:Schwartz_Bridge}

% THIS IS ACTUAL NONSENSE. NEED TO FIX THE LEAN BRIDGE BECAUSE WHILE IT IS TRUE IT IS COMPLETELY UNHELPFUL FOR THIS SITUATION.

In \cite{Viazovska8}, the proof that $a$ and $b$ are Schwartz functions involves showing that they were radially Schwartz. That is, Viazovska shows that $a(r)$ and $b(r)$ are Schwartz in $r$, these functions translating to $a\rad\of{r^2}$ and $b\rad\of{r^2}$ in our notation. There is a highly nontrivial step missing: a bridge between one-dimensional smooth, decaying functions and $8$ (and higher)-dimensional Schwartz functions. The nontriviality comes primarily from the decaying condition on higher derivatives: it is not immediate that a decaying property involving radial derivatives implies a decaying property involving high-dimensional Jacobians. To solve this problem and bridge the gap between the Schwartzness argument in $r$ and the Schwartzness criterion in $x$, a formal bridge was built to allow free translation between the radial and $\R^8$ settings.

First, we note that it is quite simple to formally build a bridge between one- and higher-dimensional Schwartz functions due to an \href{https://github.com/leanprover-community/mathlib4/blame/5a2eaa85c555c4263e15928cef249cbaad2eb2d2/Mathlib/Analysis/Distribution/SchwartzSpace.lean#L857}{intermediate result of immense import} formalised originally in Lean 3 by Moritz Doll and subsequently ported to \mathlib4: Doll's result shows that a Schwartz function composed with a function with temperate growth and a mild eventually polynomial-like condition produces another Schwartz function, and it is \href{https://github.com/thefundamentaltheor3m/Sphere-Packing-Lean/blob/704c085b1251cc0c208cc373f4e6105af359edd4/SpherePacking/ForMathlib/RadialSchwartz.lean#L38}{easy to show} the norm squared function satisfies these conditions. Therefore, if $f \in \Sch\of{\R, \C}$, then for all $d \in \N$, the map $x \mapsto f\of{\norm{x}^2}$ lives in $\Sch\of{\R^d, \C}$.

While this may appear to give us a way to show that $a$ and $b$ are Schwartz, unfortunately, our arguments do not show that $I_1, \ldots, I_6$ and $J_1, \ldots, J_6$ are Schwartz, because we do not consider how they behave on negative inputs. Indeed, up to constants, we bound them by functions like $e^{-r}$, which are decidedly not Schwartz. However, on $\Ico{0, \infty}$, they behave like Schwartz functions. By adapting Doll's argument and applying a \href{https://github.com/leanprover-community/mathlib4/blame/8b8fe2fa631658e55895b284747a997a249d3599/Mathlib/Analysis/Calculus/ContDiff/Bounds.lean#L350}{key result} originally formalised by Gouëzel in \mathlib3, the author was able to formally prove the following.
\begin{boxtheorem}[Schwartz Functions from Schwartz-Like Functions]\label{Ch5:Thm:SchwartzLike_to_Schwartz}
    Let $f : \R \to \C$ be a function that is smooth on $\Ico{0, \infty}$ such that for all $k, n \in \N$, there exists $C \in \R$ such that
    \begin{align*}
        x^{\frac{k}{2}} \cdot \abs{f^{(n)}\of{x}} \leq C
    \end{align*}
    Then, for all $d \in \N$, the function
    \begin{align*}
        f_d : \R^d \to \C : x \mapsto \fof{\norm{x}^2}
    \end{align*}
    is Schwartz.
\end{boxtheorem}
It is clear that $e^{-x}$ satisfies the conditions of \Cref{Ch5:Thm:SchwartzLike_to_Schwartz}. By extension, we can see that the $I_j$ and $J_j$---and hence, $a\rad$ and $b\rad$---do so too. This makes $a$ and $b$ Schwartz.

The author made the observation that functions obeying these conditions are invariant under linear combinations: all linear combinations certainly preserve smoothness; scaling clearly preserves rapid decay; and addition preserves rapid decay by an application of the triangle inequality. It is therefore conceivable that it might be possible to develop a theory of \textbf{Schwartz-like functions} that do not obey the Schwartzness conditions on their entire domain. Other assumptions might be required too, such as \lstinline|UniqueDiffOn ℝ S|, \lstinline|S| being the set on which the function is smooth and decaying. This is a technical property that is satisfied by $\Ico{0, \infty}$ that is used by a dependency of \Cref{Ch5:Thm:SchwartzLike_to_Schwartz}. The author's nascent progress can be found \href{https://github.com/thefundamentaltheor3m/Sphere-Packing-Lean/blob/b1d9ae9aed06b87cb811fc4b94c2c659519053b0/SpherePacking/ForMathlib/RadialSchwartz/SchwartzLike.lean#L1}{here}.

Having discussed these general contributions, we discuss two very specific and profound contributions made by the author to the formalisation effort. We begin by discussing the development of a Lean tactic by Macbeth, Xie and the author.